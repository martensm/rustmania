language: rust

cache: cargo

os: linux

matrix:
  include:
    - name: "Clippy & Rustfmt"
      # gfx_device_gl 0.16.1 requires this nightly version
      rust: nightly-2019-08-16
      # Install sound library dependencies
      addons: &addons
        apt:
            packages:
            - libasound2-dev
            - libudev-dev
      env: CLIPPY_REV_SHA=348d398
      before_script:
        - rustup component add rustfmt-preview
        - cargo install --git https://github.com/rust-lang/rust-clippy --rev $CLIPPY_REV_SHA --force clippy
      script:
        - cargo fmt --all -- --check
        - cargo clippy -- -D warnings

    - name: "Linux Stable"
      rust: stable
      addons: *addons

    - name: "Linux Nightly"
      rust: nightly-2019-08-16
      addons: *addons

    - name: "OSX Stable"
      rust: stable
      os: osx

    - name: "OSX Nightly"
      rust: nightly-2019-08-16
      os: osx

    - name: "Upload Docs"
      stage: deploy
      if: type != pull_request && branch = master
      rust: stable
      before_script:
        - cargo install cargo-update || echo "cargo-update already installed"
        - cargo install cargo-travis || echo "cargo-travis already installed"
        - cargo install-update -a
      script:
        - cargo doc --verbose && cargo doc-upload

script:
  - cargo build --verbose
  - cargo test --verbose

branches:
  only:
    - staging # bors r+
    - trying  # bors try
    - master
